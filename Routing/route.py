import subprocess

SAT_NUM = 22

src_lst = [
    # '2001:1525:1526::/48',
#    '2001:1525:1547::/24',
#    '2001:614:636::/48',
#    '2001:679:701::/48',
#    '2001:1393:1415::/48',
#    '2001:549:571::/48',
#    '2001:1504:1526::/48',
#    '2001:637:659::/48'
    '2001:1525:1526::/112',
    '2001:614:636::/112',
    '2001:679:680::112',
    '2001:1415:1416::/112',
    '2001:549:571::/112',
    '2001:637:659::/112'
    ]
dst_lst = [
    # '2001:645:646::/48',
#    '2001:623:645::/24',
#    '2001:1362:1384::/48',
#    '2001:1340:1341::/48',
#    '2001:667:668::/48',
#    '2001:1341:1363::/48',
#    '2001:777:778::/48',
#    '2001:1450:1451::/48'
    '2001:645:646::/112',
    '2001:1362:1384::/112',
    '2001:1319:1341::/112',
    '2001:668:690::/112',
    '2001:1341:1363::/112',
    '2001:644:645::/112'
    ]
path_lst = [
    # [1525,1526,1548,1570,8,30,52,74,96,118,140,162,184,206,228,250,272,294,316,338,360,382,404,426,448,470,492,514,536,558,580,602,624,646,645],
#    [1525, 1547, 1569, 7, 29, 51, 73, 95, 117, 139, 161, 183, 205, 227, 249, 271, 293, 315, 337, 359, 381, 403, 425, 447, 469, 491, 513, 535, 557, 579, 601, 623, 645],
#    [614, 636, 658, 680, 702, 724, 746, 768, 790, 812, 834, 856, 878, 900, 922, 944, 966, 988, 1010, 1032, 1054, 1076, 1098, 1120, 1142, 1164, 1186, 1208, 1230, 1252, 1274, 1296, 1318, 1340, 1362, 1384],
#    [679, 701, 723, 745, 767, 789, 811, 833, 855, 877, 899, 921, 943, 965, 987, 1009, 1031, 1053, 1075, 1097, 1119, 1141, 1163, 1185, 1207, 1229, 1251, 1273, 1295, 1317, 1339, 1340, 1341],
#    [1415, 1393, 1371, 1349, 1327, 1305, 1283, 1261, 1239, 1217, 1195, 1173, 1151, 1129, 1107, 1085, 1063, 1041, 1019, 997, 975, 953, 931, 909, 887, 865, 843, 821, 799, 777, 755, 733, 711, 689, 667, 668],
#    [549, 571, 593, 615, 637, 659, 681, 703, 725, 747, 769, 791, 813, 835, 857, 879, 901, 923, 945, 967, 989, 1011, 1033, 1055, 1077, 1099, 1121, 1143, 1165, 1187, 1209, 1231, 1253, 1275, 1297, 1319, 1341, 1363],
#    [1526, 1504, 1482, 1460, 1438, 1416, 1394, 1372, 1350, 1328, 1306, 1284, 1262, 1240, 1218, 1196, 1174, 1152, 1130, 1108, 1086, 1064, 1042, 1020, 998, 976, 954, 932, 910, 888, 866, 844, 822, 800, 778, 777],
#    [637, 659, 681, 703, 725, 747, 769, 791, 813, 835, 857, 879, 901, 923, 945, 967, 989, 1011, 1033, 1055, 1077, 1099, 1121, 1143, 1165, 1187, 1209, 1231, 1253, 1275, 1297, 1319, 1341, 1363, 1385, 1407, 1429, 1451, 1450]
    [1525, 1526, 1548, 1570, 8, 30, 52, 74, 96, 118, 140, 162, 184, 206, 228, 250, 272, 294, 316, 338, 360, 382, 404, 426, 448, 470, 492, 514, 536, 558, 580, 602, 624, 646, 645],
    [614, 636, 658, 680, 702, 724, 746, 768, 790, 812, 834, 856, 878, 900, 922, 944, 966, 988, 1010, 1032, 1054, 1076, 1098, 1120, 1142, 1164, 1186, 1208, 1230, 1252, 1274, 1296, 1318, 1340, 1362, 1384],
    [679, 680, 681, 703, 725, 747, 769, 791, 813, 835, 857, 879, 901, 923, 945, 967, 989, 1011, 1033, 1055, 1077, 1099, 1121, 1143, 1165, 1187, 1209, 1231, 1253, 1275, 1297, 1319, 1341],
    [1415, 1416, 1394, 1372, 1350, 1328, 1306, 1284, 1262, 1240, 1218, 1196, 1174, 1152, 1130, 1108, 1086, 1064, 1042, 1020, 998, 976, 954, 932, 910, 888, 866, 844, 822, 800, 778, 756, 734, 712, 690, 668],
    [549, 571, 593, 615, 637, 659, 681, 703, 725, 747, 769, 791, 813, 835, 857, 879, 901, 923, 945, 967, 989, 1011, 1033, 1055, 1077, 1099, 1121, 1143, 1165, 1187, 1209, 1231, 1253, 1275, 1297, 1319, 1341, 1363],
    [637, 659, 638, 639, 640, 641, 642, 643, 644, 645]
]

for src, dst, path in zip(src_lst, dst_lst, path_lst):
    for s1, s2 in zip(path[:-1], path[1:]):
        sat1 = f'SH1O{s1 // SAT_NUM + 1}S{s1 % SAT_NUM + 1}'
        sat2 = f'SH1O{s2 // SAT_NUM + 1}S{s2 % SAT_NUM + 1}'

#        dev1 = subprocess.check_output(f'ip netns exec {sat1} ip link | grep [[:digit:]]*-{sat2} -o', shell=True).strip().decode()
#        dev2 = subprocess.check_output(f'ip netns exec {sat2} ip link | grep [[:digit:]]*-{sat1} -o', shell=True).strip().decode()
        dev1 = subprocess.check_output(f'ip netns exec {sat1} ip -br link | grep {sat2}@ -o', shell=True).strip().decode()[:-1]
        dev2 = subprocess.check_output(f'ip netns exec {sat2} ip -br link | grep {sat1}@ -o', shell=True).strip().decode()[:-1]

        link_local1 = subprocess.check_output(f"ip netns exec {sat1} ip -6 addr show dev {dev1} | grep 'inet6 fe80'", shell=True).strip().decode()
        link_local1 = link_local1.split(' ')[1]
        link_local1 = link_local1[:link_local1.find('/')]

        link_local2 = subprocess.check_output(f"ip netns exec {sat2} ip -6 addr show dev {dev2} | grep 'inet6 fe80'", shell=True).strip().decode()
        link_local2 = link_local2.split(' ')[1]
        link_local2 = link_local2[:link_local2.find('/')]
        subprocess.run(
            ('ip', 'netns', 'exec', sat1,
            'ip', '-6', 'route', 'add', dst,
            'dev', dev1, 'via', link_local2,
            'metric', '10', 'pref', 'high')
        )
        subprocess.run(
            ('ip', 'netns', 'exec', sat2,
            'ip', '-6', 'route', 'add', src,
            'dev', dev2, 'via', link_local1,
            'metric', '10', 'pref', 'high')
        )



#[2001:1525:1526::40,
